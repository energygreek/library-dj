{% extends "home/base.html" %}
{% block title %} OPERATOR {% endblock %}

<!-- Your page content -->
{% block content %}

<div class="bs-example">
    <div class="btn-group" data-toggle="buttons">
        <label class="btn btn-primary active">
            <input type="radio" name="options" id="borrow" class="operation_select" value="borrow"> 借阅登记
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="options" id="return" class="operation_select" value="return"> 归还登记
        </label>
        <label class="btn btn-primary">
            <input type="radio" name="options" id="query" class="operation_select" value="query"> 历史查询
        </label>
    </div>
</div>
<br>
<p><input type="text" id="reader_id"  placeholder="请扫读者证条码"/></p>
<p><input type="text" id="book_code" placeholder="请扫图书条码" onkeydown="entersearch()" />  </p>
<p><button id="doprepend" onclick="operator_submit()">提交</button></p>
<table id="table" class="table table-bordered " style="overflow-y:auto;"></table>

<script>
    $(function () {
        var columns = [
            { field: "Id", title: '条码' },
            { field: 'Name', title: '书名' },
        ];
        $('#table').bootstrapTable({
            classes: "table table-hover",
            data: "",
            columns: columns,
            pageSize: 4, //每页的记录行数（*）
            pageNumber: 1,  //初始第1页
            pageList: [2, 4, 6, 8],  //这里不知道为啥没有用
            pagination: true,//是否显示分页
            locale: 'zh-CN',//中文支持,
            rowStyle: rowStyle,
            sortable: false, //是否启用排序
            sortOrder: "desc", //排序方式
            height: 250
        });
    })

    // 提交
    function operator_submit(){

        var operation = $(".operation_select:checked").val();
        var reader_id = $("#reader_id").val();        
        var data= $('#table').bootstrapTable('getData',false);
        var token = "{{ csrf_token }}"

        $.ajax({
        type: "POST",
        url: "{% url 'bookmanage:operatebook' %}",
        contentType: "application/json;charset=utf-8",
        dataType: "json",
        headers: { 'X-CSRFTOKEN': token },
        data: {"reader_id": reader_id, "operation": operation, "data":data },
        json: 'callback',
        success: function (msg) {
            json_msg = JSON.parse(msg)[0]['fields'];
            $('#table').bootstrapTable('append', json_msg);
        },
        error: function () {
            alert("错误");
        }
        });
    }

    // 扫码触发事件
    function entersearch(){
        var event = window.event || arguments.callee.caller.arguments[0];
        if (event.keyCode == 13)
        {
            doprepend();
        }
    }

    // 添加数据
    function doprepend() {

        var book_code = $("#book_code").val();
        var rows = $("#table_borrow tr");
        if (book_code == "" || book_code == null) {
            alert("条码不能为空");
            return false;
        }
        //防呆防止数据重复
        if (rows.length > 0) {
            for (var i = 0; i < rows.length; i++) {
                var center = rows[i].cells[0].innerText.replace(/\s+/g, "");//循环遍历获取table的id
                if (center == book_code) {//判断是否为同一个id
                    alert("条码不允许重复扫描");
                    return false;
                }
            }
        }

        

        var newData = [
            { Id: ID, Name: Name },
        ];
        $('#table-br').bootstrapTable('prepend', newData);//追加到Table **`注：prepend追加到第一行，Append 添加到最后一行`**
    }
    //添加行内样式
    function rowStyle(row, index) {
        var style = {};
        if (row.Age > 35) {
            style = { css: { 'background-color': '#ed5565' } };
        }
        return style;
    }
</script>

{% endblock %}